# üöÄ zpgxpool ‚Äî Lightweight pgx pool interface + testing mocks

[![CI](https://github.com/ZihxS/zpgxpool/actions/workflows/ci.yml/badge.svg)](https://github.com/ZihxS/zpgxpool/actions/workflows/ci.yml) [![Go](https://img.shields.io/badge/go-1.24-blue.svg)](https://golang.org) [![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

A compact helper library and mock utilities for working with PostgreSQL via [`pgx`](github.com/jackc/pgx/v5) in Go. Ideal for projects that need:
- A small, test-friendly abstraction over `pgx` connection pool
- Ready-to-use mocks for unit tests (using `gomock`)
- Clear examples to run & learn from

üìå Short: fast to adopt, easy to test, and designed for clean unit testing patterns.

---

## ‚ö° Quick links
- Full documentation: [`DOCUMENTATION.md`](DOCUMENTATION.md:1)
- Examples folder (runnable tests): [`examples/README.md`](examples/README.md:1)
- Source: this repository root

---

## üì¶ Why use zpgxpool?

- Replace direct `pgx` calls in business logic with interfaces to make unit testing trivial.
- Use generated mocks (`gomock`) to assert interactions, simulate errors, and test transaction flows without a real DB.
- Includes utilities to create fake rows (`NewRows`, `NewRow`) to simulate query results (including NULLs and CSV input).

---

## üß≠ Quick Start

1. Add repository as a module dependency (or vendor locally):
```bash
go get github.com/zihxs/zpgxpool
```

2. Use the `PgxPool` interface in your code:
```go
var db zpgxpool.PgxPool = realPool // or injected mock in tests
row := db.QueryRow(ctx, "SELECT id FROM users WHERE id = $1", 1)
```

3. Run examples:
```bash
cd examples && go test ./...
```
See [`examples/README.md`](examples/README.md:1) for details.

---

## üß™ Unit testing patterns

- Create mock controller:
```go
ctrl := gomock.NewController(t)
defer ctrl.Finish()
mockPool := zpgxpool.NewMockPgxPool(ctrl)
```

- Return mocked rows:
```go
rows := zpgxpool.NewRows([]string{"id","name"}).AddRow(1,"John")
mockPool.EXPECT().Query(gomock.Any(), "SELECT ...").Return(rows.ToPgxRows(), nil)
```

- Test transaction behavior with `MockTx`:
mockTx := zpgxpool.NewMockTx(ctrl)
mockPool.EXPECT().Begin(gomock.Any()).Return(mockTx, nil)
mockTx.EXPECT().Exec(gomock.Any(), "INSERT ...", gomock.Any()).Return(pgconn.NewCommandTag("INSERT 0 1"), nil)
mockTx.EXPECT().Commit(gomock.Any()).Return(nil)
```

---

## üìÇ Examples included (runnable)
- `successful_query_test.go` ‚Äî multi-row query ‚úÖ
- `successful_transaction_test.go` ‚Äî transaction commit ‚úÖ
- `query_error_test.go` ‚Äî simulate query error ‚ùå
- `transaction_rollback_test.go` ‚Äî simulate rollback on error üîÅ
- `empty_query_results_test.go` ‚Äî no rows edge case ‚ö†Ô∏è
- `null_values_test.go` ‚Äî scan NULL values into pointers üå´Ô∏è
- `single_row_result_test.go` ‚Äî QueryRow usage 1Ô∏è‚É£
- `nested_transactions_test.go` ‚Äî nested transaction scenarios üßµ
- `batch_operations_test.go` ‚Äî send batch and verify results üî•

Run all examples:
```bash
cd examples && go test ./...
```

---

## üõ†Ô∏è Implementation notes (for contributors)

- Interfaces are defined in [`pgx_pool.go`](pgx_pool.go:11).
- Mocks are generated by `gomock` and included (`pgx_pool_mock.go`) to avoid requiring mock generation during CI.
- Row/Rows helpers defined in [`row.go`](row.go:1) and [`rows.go`](rows.go:1).

If you change interfaces, re-generate mocks with:
```bash
mockgen -destination=pgx_pool_mock.go -package=zpgxpool path/to/your/module PgxPool,Tx
```

---

## ‚úÖ SEO & discovery tips (for repository settings)

- Add GitHub topics: `pgx`, `postgres`, `golang`, `go`, `db`, `mock`, `testing`, `unit-tests`
- Set repository description to: "zpgxpool ‚Äî lightweight pgx pool interfaces + gomock-ready testing utilities for PostgreSQL in Go"
- Pin this README and [`DOCUMENTATION.md`](DOCUMENTATION.md:1) for discoverability.
- Add `examples/` as a top-level folder and list it in README for quick onboarding.

---

## ü§ù Contribution & Code of Conduct

Contributions welcome ‚Äî please open issues or pull requests. Follow repository coding and PR guidelines:
- Small iterative PRs
- Tests included for new features
- Update docs / examples when behavior changes

---

If this project helped you speed up DB testing, please:
- Star the repo ‚≠ê
- Share an example of how you use it
- Open issues for missing features or improvements

Thanks ‚Äî and happy testing! üéâ

---

- Keywords: pgx, postgres, golang, db pool, pgxpool, mocking, gomock, unit test, database testing, sql transactions.
- Ideal for: backend services, microservices, Open Source libraries using PostgreSQL and Go.
- Features: interface abstractions (`PgxPool`, `Tx`), mock generator output, utilities to build `pgx.Rows` and `pgx.Row` for tests, examples.
